{% extends 'base.html' %}

{% block title %}Link Criado com Sucesso{% endblock %}

{% block content %}
<div class="success-page">

    <div class="success-header">
        <div class="success-icon-lg">
            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        </div>
        <h2>Link Criado!</h2>
        <p>Tudo pronto para receber o pagamento.</p>
    </div>

    <div class="card-summary mb-4">
        <div class="valor-container">
            <span class="valor-label">Valor do Link</span>
            <div class="valor-destaque">R$ {{ order.total|floatformat:2 }}</div>
            
            {% if order.installments > 1 %}
                <span class="status-badge-success">
                    {{ order.installments }}x sem juros
                </span>
            {% else %}
                <span class="status-badge-neutral">Pagamento à vista</span>
            {% endif %}
        </div>

        <div class="detalhes-lista">
            <div class="detalhe-linha">
                <span>Cliente</span>
                <strong>{{ order.name|truncatechars:25 }}</strong>
            </div>
            <div class="detalhe-linha">
                <span>Vendedor</span>
                <strong>{{ order.seller.name|truncatechars:25 }}</strong>
            </div>
            <div class="detalhe-linha sub-info">
                <span>Produtos + Frete</span>
                <span>R$ {{ order.value }} + R$ {{ order.value_freight }}</span>
            </div>
        </div>
    </div>

    <div class="link-section mb-4">
        <label class="section-label">Link de Pagamento</label>
        {% if payment_link %}
            <div class="link-copy-wrapper">
                <input type="text" id="linkGerado" value="{{ payment_link.url_link }}" readonly>
                <button id="btnCopiar" title="Copiar Link">
                    <i class="bi bi-copy"></i>
                </button>
            </div>
            <div id="msgCopiado" class="copy-alert">
                <i class="bi bi-check-circle-fill"></i> Link copiado com sucesso!
            </div>
        {% else %}
            <div class="alert alert-warning">Erro ao recuperar a URL do link.</div>
        {% endif %}
    </div>

    <div class="acoes-grid">
        <button class="btn-share-action whatsapp" id="btnWhatsApp">
            <i class="bi bi-whatsapp"></i>
            WhatsApp
        </button>

        <button class="btn-share-action share" id="btnCompartilhar">
            <i class="bi bi-share"></i>
            Outros
        </button>
    </div>

    <div class="navigation-footer">
        <a href="{% url 'orders:order-create' %}" class="btn-new-order">
            <i class="bi bi-plus-lg"></i> Criar outro link
        </a>
        <a href="#" class="link-back-list">
            <i class="bi bi-list-ul"></i> Ver todos os links
        </a>
    </div>

</div>
{% endblock %}

{% block extra_css %}
<style>
/* Estrutura Base */
.success-page { max-width: 480px; margin: 0 auto; padding: 20px 15px; }

/* Header */
.success-header { text-align: center; margin-bottom: 2rem; }
.success-icon-lg {
    width: 72px; height: 72px; background: var(--success); color: white;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    margin: 0 auto 1rem; box-shadow: 0 10px 15px -3px rgba(16, 185, 129, 0.3);
    animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}
.success-header h2 { font-weight: 800; color: var(--gray-900); margin-bottom: 0.25rem; }
.success-header p { color: var(--gray-500); font-size: 0.95rem; }

/* Card Resumo */
.card-summary { 
    background: white; border-radius: 20px; border: 1px solid var(--gray-200);
    padding: 1.5rem; box-shadow: var(--shadow-sm);
}
.valor-container { text-align: center; margin-bottom: 1.5rem; }
.valor-label { font-size: 0.75rem; font-weight: 700; color: var(--gray-400); text-transform: uppercase; }
.valor-destaque { font-size: 2.5rem; font-weight: 800; color: var(--gray-900); letter-spacing: -1px; }

.status-badge-success { background: var(--success-light); color: var(--success); padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
.status-badge-neutral { background: var(--gray-100); color: var(--gray-600); padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }

.detalhes-lista { border-top: 1px solid var(--gray-100); padding-top: 1rem; }
.detalhe-linha { display: flex; justify-content: space-between; font-size: 0.9rem; margin-bottom: 0.5rem; }
.sub-info { font-size: 0.8rem; color: var(--gray-400); margin-top: 0.5rem; }

/* Link Input */
.section-label { font-size: 0.8rem; font-weight: 700; color: var(--gray-600); margin-bottom: 0.5rem; display: block; }
.link-copy-wrapper { 
    display: flex; background: var(--gray-50); border: 2px solid var(--gray-200); 
    border-radius: 12px; overflow: hidden; transition: border-color 0.2s;
}
.link-copy-wrapper:focus-within { border-color: var(--primary); }
.link-copy-wrapper input { 
    flex: 1; border: none; background: transparent; padding: 12px 15px;
    font-family: monospace; font-size: 0.85rem; color: var(--gray-700); outline: none;
}
.link-copy-wrapper button { 
    background: var(--primary); color: white; border: none; padding: 0 15px; 
    cursor: pointer; transition: background 0.2s;
}
.link-copy-wrapper button:active { background: var(--primary-dark); }

.copy-alert { 
    font-size: 0.8rem; color: var(--success); text-align: center; margin-top: 0.5rem;
    font-weight: 600; opacity: 0; transform: translateY(-5px); transition: all 0.3s;
}
.copy-alert.show { opacity: 1; transform: translateY(0); }

/* Ações */
.acoes-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.btn-share-action {
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    gap: 8px; padding: 16px; border-radius: 16px; border: none; font-weight: 700;
    font-size: 0.9rem; cursor: pointer; transition: transform 0.1s, box-shadow 0.2s;
}
.btn-share-action:active { transform: scale(0.95); }
.btn-share-action.whatsapp { background: #25D366; color: white; } /* WhatsApp brand color kept */
.btn-share-action.share { background: var(--gray-100); color: var(--gray-800); }

/* Footer */
.navigation-footer { margin-top: 2rem; display: flex; flex-direction: column; gap: 1rem; text-align: center; }
.btn-new-order { 
    background: var(--gray-900); color: white; padding: 14px; border-radius: 12px;
    text-decoration: none; font-weight: 600; display: block;
}
.link-back-list { color: var(--gray-500); font-size: 0.9rem; text-decoration: none; font-weight: 500; }

@keyframes bounceIn {
    0% { transform: scale(0.3); opacity: 0; }
    50% { transform: scale(1.05); opacity: 1; }
    70% { transform: scale(0.9); }
    100% { transform: scale(1); }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const linkInput = document.getElementById('linkGerado');
    const url = linkInput ? linkInput.value : '';

    // 1. Função Copiar
    document.getElementById('btnCopiar')?.addEventListener('click', () => {
        linkInput.select();
        navigator.clipboard.writeText(url);
        const alert = document.getElementById('msgCopiado');
        alert.classList.add('show');
        setTimeout(() => alert.classList.remove('show'), 2500);
    });

    // 2. Enviar WhatsApp
    document.getElementById('btnWhatsApp')?.addEventListener('click', () => {
        const msg = encodeURIComponent(`Olá! Segue o seu link de pagamento no valor de R$ {{ order.total|floatformat:2 }}:\n\n${url}`);
        window.open(`https://api.whatsapp.com/send?text=${msg}`, '_blank');
    });

    // 3. Compartilhamento Nativo (Mobile)
    document.getElementById('btnCompartilhar')?.addEventListener('click', async () => {
        if (navigator.share) {
            try {
                await navigator.share({
                    title: 'Link de Pagamento',
                    text: 'Pague seu pedido com facilidade através deste link:',
                    url: url
                });
            } catch (err) { console.log('Erro ao compartilhar'); }
        } else {
            // Se não tiver suporte a share, apenas foca no copiar
            document.getElementById('btnCopiar').click();
        }
    });
});
</script>
{% endblock %}